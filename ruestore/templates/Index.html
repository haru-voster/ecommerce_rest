{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RUESTORE</title>

<link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/styles.css' %}">

<style>
body{
    font-family: 'Montserrat', sans-serif;
    margin:0;
    background:#f6f7fb;
}

/* HEADER */
header{
    background:#111;
    color:white;
    padding:15px 40px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.logo{font-size:26px;font-weight:700;}
.nav a{color:white;margin-left:20px;text-decoration:none;font-weight:600;}
.nav a:hover{color:#ff4d4d;}

/* HERO */
.hero{text-align:center;padding:40px 20px 10px;}
.hero h2{font-size:32px;margin-bottom:10px;}
.hero p{color:#666;}

/* GRID */
#productContainer{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
    gap:25px;
    padding:40px;
}

/* CARD */
.product-card{
    background:white;
    border-radius:16px;
    box-shadow:0 6px 20px rgba(0,0,0,0.08);
    padding:20px;
    text-align:center;
    transition:.3s;
}
.product-card:hover{
    transform:translateY(-8px);
    box-shadow:0 12px 30px rgba(0,0,0,0.15);
}
.product-card img{
    width:100%;
    height:180px;
    object-fit:contain;
}
.price{color:#e63946;font-size:20px;font-weight:700;margin:10px 0;}
.specs{font-size:14px;color:#666;}

.product-card button{
    margin-top:15px;
    padding:10px 18px;
    border:none;
    border-radius:8px;
    background:#2c3e50;
    color:white;
    font-weight:600;
    cursor:pointer;
}
.product-card button:hover{background:black;}

/* FOOTER */
footer{text-align:center;background:#111;color:#aaa;padding:25px;margin-top:40px;}

/* MODAL */
.modal{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.75);
    display:none;
    justify-content:center;
    align-items:center;
}
.modal-box{
    background:white;
    width:900px;
    max-width:95%;
    border-radius:16px;
    padding:25px;
}
.close{float:right;font-size:26px;cursor:pointer;font-weight:bold;}

.modal-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:30px;
    align-items:center;
}

/* VIEWER */
.viewer{
    width:100%;
    height:320px;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:hidden;
    border-radius:12px;
    background:#f4f4f4;
    cursor:grab;
}
.viewer img{
    max-width:100%;
    max-height:100%;
    transition:.2s;
}

/* THUMBS */
.thumbs{
    display:flex;
    gap:10px;
    margin-top:10px;
    justify-content:center;
    flex-wrap:wrap;
}
.thumbs img{
    width:60px;
    height:60px;
    object-fit:contain;
    border:2px solid transparent;
    border-radius:8px;
    cursor:pointer;
}
.thumbs img.active{
    border-color:#111;
}
.thumbs img:hover{
    border-color:#e63946;
}

/* CONTROLS */
.viewer-controls{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:12px;
}
.viewer-controls button{
    border:none;
    background:#111;
    color:white;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
}
.viewer-controls button:hover{background:#e63946;}

.modal-price{
    font-size:24px;
    color:#e63946;
    font-weight:700;
    margin-bottom:15px;
}

#modalSpecs{
    max-height:200px;
    overflow:auto;
    padding-left:18px;
}

.cart-btn{
    padding:12px;
    border:none;
    background:#111;
    color:white;
    border-radius:10px;
    width:100%;
    margin-top:20px;
    cursor:pointer;
}
.cart-btn:hover{background:#e63946;}

@media(max-width:700px){
.modal-grid{grid-template-columns:1fr;}
header{flex-direction:column;}
}
</style>
</head>
<body>

<header>
<div class="logo">RUESTORE</div>
<div class="nav">
<a href="#">Home</a>
<a href="#">Products</a>
<a href="#">Contact</a>
<a href="#">Account</a>
</div>
</header>

<section class="hero">
<h2>Welcome to RUESTORE</h2>
<p>Browse our wide selection of electronics below.</p>
</section>

<div id="productContainer">Loading products...</div>

<footer>
© <script>document.write(new Date().getFullYear())</script> RUESTORE
</footer>


<!-- MODAL -->
<div id="productModal" class="modal">
<div class="modal-box">

<span class="close" onclick="closeModal()">×</span>

<div class="modal-grid">

<div class="modal-img">

<div class="viewer">
<img id="modalImage">
</div>

<div id="thumbnailContainer" class="thumbs"></div>

<div class="viewer-controls">
<button onclick="rotateLeft()">⟲</button>
<button onclick="zoomIn()">＋</button>
<button onclick="zoomOut()">－</button>
<button onclick="rotateRight()">⟳</button>
</div>

</div>

<div>
<h2 id="modalTitle"></h2>
<div class="modal-price" id="modalPrice"></div>
<ul id="modalSpecs"></ul>
<button class="cart-btn">Add To Cart</button>
</div>

</div>
</div>
</div>


<script>
const container = document.getElementById("productContainer");

/* helper to build correct image url */
function getImageUrl(path){
    if(!path) return "/static/img/no-image.png";

    // already full URL
    if(path.startsWith("http")) return path;

    // ensure leading slash
    if(!path.startsWith("/")) path = "/" + path;

    return path;
}

fetch("{% url 'product-list' %}")
.then(res => res.json())
.then(data => {

    if(!data.length){
        container.innerHTML = "<p>No products found</p>";
        return;
    }

    container.innerHTML = data.map(p => {
        // get first image for card display
        let firstImage = (p.images && p.images.length) ? p.images[0].image : null;

        return `
        <div class="product-card">
            <img src="${getImageUrl(firstImage)}">
            <h3>${p.name}</h3>
            <div class="price">Ksh ${p.price}</div>
            <div class="specs">
                RAM: ${p.ram}<br>
                CPU: ${p.processor}<br>
                Storage: ${p.storage}
            </div>
            <button onclick='showDetails(${JSON.stringify(p)})'>
                View Details
            </button>
        </div>
        `;
    }).join("");

})
.catch(err=>{
    console.error(err);
    container.innerHTML = "<p style='color:red'>Failed to load products</p>";
});


/* MODAL */
function showDetails(p){
    document.getElementById("modalTitle").innerText = p.name;
    document.getElementById("modalPrice").innerText = "Ksh " + p.price;

    let main = document.getElementById("modalImage");

    /* thumbnails */
    let thumbs = document.getElementById("thumbnailContainer");

    // map images properly
    let images = (p.images && p.images.length) ? p.images.map(i=>i.image) : [];

    thumbs.innerHTML = images.map((img,index)=>
        `<img src="${getImageUrl(img)}"
              class="${index===0 ? 'active' : ''}"
              onclick="changeImage(this,'${getImageUrl(img)}')">`
    ).join("");

    // set first image as main
    if(images.length){
        main.src = getImageUrl(images[0]);
    } else {
        main.src = "/static/img/no-image.png";
    }

    document.getElementById("modalSpecs").innerHTML = `
    <li><b>Processor:</b> ${p.processor}</li>
    <li><b>RAM:</b> ${p.ram}</li>
    <li><b>Storage:</b> ${p.storage}</li>
    <li><b>Graphics:</b> ${p.graphics}</li>
    <li><b>Display:</b> ${p.display}</li>
    <li><b>Camera:</b> ${p.camera}</li>
    <li><b>Warranty:</b> ${p.warranty}</li>
    <li>${p.description}</li>
    `;

    document.getElementById("productModal").style.display = "flex";
}


/* change image */
function changeImage(el,src){
    document.getElementById("modalImage").src = src;
    document.querySelectorAll(".thumbs img").forEach(i=>i.classList.remove("active"));
    el.classList.add("active");
}


/* close modal */
function closeModal(){
    document.getElementById("productModal").style.display="none";
    scale=1;rotation=0;updateTransform();
}

window.onclick = e => {
    if(e.target.id === "productModal") closeModal();
};


/* VIEWER CONTROLS */
let scale = 1, rotation = 0, isDragging = false, startX;
const img = document.getElementById("modalImage");

function rotateLeft(){ rotation -= 90; updateTransform(); }
function rotateRight(){ rotation += 90; updateTransform(); }
function zoomIn(){ scale += 0.2; updateTransform(); }
function zoomOut(){ scale = Math.max(0.4, scale - 0.2); updateTransform(); }
function updateTransform(){ img.style.transform = `scale(${scale}) rotate(${rotation}deg)`; }

img.addEventListener("mousedown", e=>{
    isDragging = true;
    startX = e.clientX;
    img.style.cursor="grabbing";
});

window.addEventListener("mouseup", ()=>{
    isDragging = false;
    img.style.cursor="grab";
});

window.addEventListener("mousemove", e=>{
    if(!isDragging) return;
    let diff = e.clientX - startX;
    rotation += diff * 0.5;
    startX = e.clientX;
    updateTransform();
});
</script>

</body>
</html>